<link rel="stylesheet" href="/css/nam_book_detail.css">
<link rel="stylesheet" href="/css/jjlee_book_detail.css">
<link rel="stylesheet" href="/css/khang_book_detail_base.css">
<link rel="stylesheet" href="/css/khang_book_detail_main.css">
<link rel="stylesheet" href="/css/comment.css">

<body>

    <div id="product-detail-page">

        <div id="detail-and-buy" class="d-flex justify-content-center">

            <img class="product-img col col-6 d-flex justify-content-center" src="{{book.image}}">



            <div id="product-buy-detail" class="col col-6">

                <div class="detail-header">
                    <h2 class="detail-title" style="color: black; font-weight: 600">{{book.title}}</h2>
                    <div class="detail-rating">

                        {{!-- light star --}}
                        <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" size="16"
                            color="#fdd836" height="16" width="16" xmlns="http://www.w3.org/2000/svg"
                            style="color: rgb(253, 216, 54);">
                            <path
                                d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z">
                            </path>
                        </svg>

                        {{!-- light star --}}
                        <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" size="16"
                            color="#fdd836" height="16" width="16" xmlns="http://www.w3.org/2000/svg"
                            style="color: rgb(253, 216, 54);">
                            <path
                                d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z">
                            </path>
                        </svg>

                        {{!-- light star --}}
                        <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" size="16"
                            color="#fdd836" height="16" width="16" xmlns="http://www.w3.org/2000/svg"
                            style="color: rgb(253, 216, 54);">
                            <path
                                d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z">
                            </path>
                        </svg>

                        {{!-- light star --}}
                        <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" size="16"
                            color="#fdd836" height="16" width="16" xmlns="http://www.w3.org/2000/svg"
                            style="color: rgb(253, 216, 54);">
                            <path
                                d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z">
                            </path>
                        </svg>

                        {{!-- dark star --}}
                        <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" size="16"
                            color="#c7c7c7" style="color:#c7c7c7" height="16" width="16"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z">
                            </path>
                        </svg>

                    </div>
                    <a href="#">(Xem <span>44</span> đánh giá)</a>
                    <div class="detail-sold">Đã bán <span>888</span></div>
                </div>

                <div class="detail-cost">
                    {{book.price}} VNĐ
                </div>

                <div class="detail-coupon">
                    <div class="coupon-text">Mã giảm giá</div>
                    <ul class="coupon-tags">
                        <li class="coupon-tag">Giảm 30k</li>
                        <li class="coupon-tag">Giảm 25k</li>
                        <li class="coupon-tag">Giảm 15k</li>
                        <a href="#"><i class="coupon-detail-icon ti-angle-right"></i></a>
                    </ul>

                </div>

                <div class="detail-buy">
                    {{!-- <p class="label">Số lượng</p> --}}

                    <div class="group-input">
                        {{!-- <button class="change-btn buy-btn" id="decre-btn"><i class="ti-minus"></i></button>
                        <input type="text" value="1" class="input">
                        <button class="change-btn buy-btn" id="incre-btn"><i class="ti-plus"></i></button> --}}

                        <div>
                            <button class="submit-btn buy-btn" id="buyItem">Chọn mua</button>
                            <button id="addItemToCart" class="submit-btn buy-btn">Add to cart</button>
                        </div>
                    </div>

                </div>

            </div>

        </div>


        <div class="">
            <div class="">
                <div class="detail__container">
                    <div class="detail__heading">
                        Thông tin chi tiết
                    </div>
                    <div class="detail__table">
                        <table>
                            <tbody>
                                <tr>
                                    <td>Công ty phát hành</td>
                                    <td>Gubooks</td>
                                </tr>
                                <tr>
                                    <td>Ngày xuất bản</td>
                                    <td>2021-06-01 00:00:00</td>
                                </tr>
                                <tr>
                                    <td>Kích thước</td>
                                    <td>13.5 x 20 cm</td>
                                </tr>
                                <tr>
                                    <td>Dịch giả</td>
                                    <td>Đặng Quân</td>
                                </tr>
                                <tr>
                                    <td>Loại bìa</td>
                                    <td>Bìa mềm</td>
                                </tr>
                                <tr>
                                    <td>Số trang</td>
                                    <td>{{book.no}}</td>
                                </tr>
                                <tr>
                                    <td>Nhà xuất bản</td>
                                    <td>Nhà xuất bản Nhi đồng</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="detail__description">
                    <div class="detail__description-heading">
                        Mô Tả Sản Phẩm
                    </div>
                    <div class="detail__description-content">
                        {{book.body}}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        {{!-- home books --}}
        <div class="home-product" style="margin-left: 18px; margin-right: 18px; border-bottom: 0px, solid, #fff"
            id="home-books">

            <div class="product-header" id="books-header">
                <span>Có thể bạn thích</span>
                <i class="product-icon ti-book"></i>
            </div>

            <div class="carousel slide" style="height: 400px" data-ride="carousel" data-interval="5000">

                <div class="carousel-inner row w-100 mx-auto" style="height: 100%; box-shadow: none" role="listbox">

                    {{#each books}}

                    <a href="/books/{{this.slug}}" class="carousel-item col-md-3">

                        <div class="panel panel-default">
                            <div class="panel-thumbnail">
                                <div title="image 1" class="thumb">
                                    <img class="img-fluid mx-auto d-block" src="{{this.image}}" alt="slide 1">
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">{{this.title}}</h5>

                                <p class="card-text">{{this.body}}</p>

                                <div class="item-price flex">
                                    <div class="price-value">{{this.price}} VNĐ</div>
                                </div>
                            </div>
                        </div>

                    </a>
                    {{/each}}

                </div>
                {{!-- book prev icon --}}
                <a class="carousel-control-prev" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                </a>
                {{!-- book next icon --}}
                <a class="carousel-control-next text-faded" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                </a>
            </div>

        </div>
        <h2 class="feedback-title" style="margin-left: 16px; font-weight: 600px; font-size: 32px">Feedback</h2>
        <div class="feedback-container">

            <div>
                <div id="commentForm">

                    {{#if user}}

                    <div class="reply-container">
                        <div class="replyForm">
                            <input type="text" name="username" class="user pt-2" id="username" value={{user.username}}
                                readonly style="display: none">
                            <input type="text" name="me_avatar" id="me_avatar" value={{user.avatar}}
                                style="display: none">
                            <input type="text" name="me_avatar" id="user_avatar" value={{user.avatar}}
                                style="display: none">
                            <span class="round"><img src="{{user.avatar}}" class="align-self-start mr-3"
                                    style="border-radius: 50%; height: 36px"></span>
                            <div class="reply-input">
                                <input type="text" name="content" placeholder="Bạn đánh giá gì về sản phẩm này?"
                                    style="font-size: 14px" onkeyup="showSendBox(this)" id="content">
                                <input name="itemId" id="itemId" value="{{book._id}}" style="display:none">

                            </div>
                        </div>
                        <div id="send-box" class="reply-btn" style="display: none">
                            <button class="no-replySendBtn" onclick="hideCommentBox(this)">
                                Hủy
                            </button>
                            <button type="button" class="replySendBtn" id="commentSendBtn" onClick="sendReply(this)"
                                disabled="disabled">Đánh giá</button>
                        </div>
                    </div>

                    {{/if}}
                </div>
            </div>
            <div id="commentBox">
                {{#if commentList.length}}
                <h3 style="margin-left: 28px; margin-bottom: 24px">Comment ({{commentList.length}})</h3>
                <div id="commentBox-content">
                    {{#each commentList}}
                    <div id="{{this._id}}" class="each_comment_box">
                        <div class="media d-flex align-items-start">
                            <span class="round"><img src="{{this.avatar}}" class="align-self-start mr-3"
                                    style="border-radius: 50%; height: 36px"></span>
                            <div class="container">
                                <div class="d-flex flex-column align-items-stretch justify-content-evenly comment-container"
                                    style="flex: 1">
                                    <span class="user pt-2 username">{{this.username}}</span>
                                    <div class="d-flex justify-content-between">
                                        <div class="d-flex justify-content-betweens align-items-center">
                                            <div class="content">{{this.content}}</div>
                                        </div>
                                    </div>
                                </div>
                                <p class="actions">
                                    <span class="action-like">Thích</span>
                                    .
                                    <span class="action-comment" onclick="showReplyBox(this)">Trả lời</span>
                                    .
                                    <span class="date">{{this.updatedAt}}</span>
                                </p>
                            </div>
                        </div>

                        <div class="reply-container" style="display: none">
                            <div class="replyForm">
                                <input type="text" name="me_avatar" id="me_avatar" value={{../user.avatar}}
                                    style="display: none">
                                <span class="round"><img src="{{../user.avatar}}" class="align-self-start mr-3"
                                        style="border-radius: 50%; height: 36px"></span>
                                <div class="reply-input">
                                    <input type="text" name="me" id="me" value={{../user.username}}
                                        style="display: none">
                                    <input type="text" name="reply" id="reply" onkeyup="changeBtnStatus(this)">
                                    <input name="commentId" id="commentId" value="{{this._id}}" style="display: none">

                                </div>
                            </div>
                            <div class="reply-btn">
                                <button class="no-replySendBtn" onclick="hideReplyBox(this)">
                                    Hủy
                                </button>
                                <button type="button" class="replySendBtn" onClick="sendReply(this)">Trả lời</button>
                            </div>
                        </div>

                        <div class="replyList">
                            {{#if this.replyList.length}}
                            <h3 style="margin-left: 55px; margin-right: 12px">Xem {{this.replyList.length}} câu trả lời
                            </h3>

                            <div class="replyList-body">
                                {{#each this.replyList}}
                                <div class="media d-flex align-items-start">
                                    <span class="round"><img src="{{this.avatar}}" class="align-self-start mr-3"
                                            style="border-radius: 50%; height: 36px"></span>
                                    <div class="container">
                                        <div class="d-flex flex-column align-items-stretch justify-content-evenly comment-container"
                                            style="flex: 1">
                                            <span class="user pt-2 username">{{this.username}}</span>
                                            <div class="d-flex justify-content-between">
                                                <div class="d-flex justify-content-betweens align-items-center">
                                                    <div class="content">{{this.content}}</div>

                                                </div>
                                            </div>
                                        </div>
                                        <p class="actions">
                                            <span class="action-like">Thích</span>
                                            .
                                            <span class="action-comment">Trả lời</span>
                                            .
                                            <span class="date">{{this.updatedAt}}</span>
                                        </p>
                                    </div>
                                </div>
                                {{/each}}


                            </div>

                            {{else}}
                                <div class="replyList-body">
                                    
                            </h3>
                                </div>
                            {{/if}}

                        </div>
                    </div>
                    {{/each}}
                </div>
                {{else}}
                <div id="commentBox-content">

                </div>
                {{/if}}
            </div>
        </div>


    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="../socket.io/socket.io.js"></script>
    <script src="/js/datetime_handling.js"></script>

    <script src="/js/book_detail.js"></script>
    <script>
        var socket = io("http://localhost:3000")

        function showSendBox(input) {
            console.log(input.value)
            if (input.value == '') {
                document.getElementById("commentSendBtn").style.backgroundColor = "#ccc"
                document.getElementById("commentSendBtn").disabled = true
            } else {
                document.getElementById("commentSendBtn").style.backgroundColor = "#c39e51"
                document.getElementById("commentSendBtn").disabled = false
            }

        }

        function showReplyBox(btn) {
            const commentId = btn.parentElement.parentElement.parentElement.parentElement.id
            $(`#${commentId} .reply-container`).css('display', 'block')
        }

        function changeBtnStatus(input) {
            console.log(input.value)
            const commentId = input.parentElement.parentElement.parentElement.parentElement.id
            if (input.value == '') {
                $(`#${commentId} .replySendBtn`).css('background-color', "#ccc")
                $(`#${commentId} .replySendBtn`).prop('disabled', true)
            } else {
                $(`#${commentId} .replySendBtn`).css('background-color', "#c39e51")
                $(`#${commentId} .replySendBtn`).prop('disabled', false)
            }
        }

        function hideCommentBox(btn) {
            $(`#commentBox #content`).val('')
            $(`#send-box`).css('display', "none")
        }

        function hideReplyBox(btn) {
            const commentId = btn.parentElement.parentElement.parentElement.id
            $(`#${commentId} .reply-container`).css('display', "none")
            $(`#${commentId} #reply`).val('')
        }

        function sendReply(replyButton) {
            const commentId = replyButton.parentElement.parentElement.parentElement.id
            const data = {
                username: $(`#${commentId} .replyForm #me`).val(),
                content: $(`#${commentId} .replyForm #reply`).val(),
                avatar: $(`#${commentId} .replyForm #me_avatar`).val(),
                parentCommentId: commentId,
            }


            $.ajax({
                url: '/books/reply-comment',
                method: 'POST',
                data: data,
                success: function (res) {
                    socket.emit("client_send_reply_comment", res)
                }
            });
            return false;
        }




        $(document).ready(function () {




            $("#content").focus(function () {
                $("#send-box").css("display", "flex")
            })

            if ($("#content").val() == '') {
                $("#commentSendBtn").css("background-color", "#ccc");
            }




            $("#commentSendBtn").click(function () {

                var data = {
                    username: $("#username").val(),
                    content: $("#content").val(),
                    itemId: $("#itemId").val(),
                    avatar: $("#user_avatar").val()
                }

                console.log(data)



                $.ajax({
                    url: "/books/do-comment",
                    method: "POST",
                    data: data,
                    success: function (res) {
                        socket.emit("client_send_comment_to_book_item", res)
                    }
                });

                return false;
            });

            const data = {
                username: $("#username").val(),
                itemId: $("#itemId").val(),
            }



            $("#addItemToCart").click(function () {


                $.ajax({
                    url: '/carts/add-book-to-cart',
                    method: "POST",
                    data: data,
                    success: function (res) {

                        $("#cart-number").text(res.itemList.length);
                    }
                })

            })

            $("#buyItem").click(function () {


                $.ajax({
                    url: '/carts/add-book-to-cart',
                    method: "POST",
                    data: data,
                    success: function (res) {

                        location.href = `/carts/${res.username}?level=${res.level}`
                    }
                })


            })


            socket.on("server_send_comment_to_book_item", function (data) {

                var html = `
                <div id="${data._id}" class="each_comment_box">
                    
                    <div class="media d-flex align-items-start">
                        <span class="round"><img src="${data.avatar}" class="align-self-start mr-3"
                                style="border-radius: 50%; height: 36px"></span>
                        <div class="container">
                            <div class="d-flex flex-column align-items-stretch justify-content-evenly comment-container"
                                style="flex: 1">
                                <span class="user pt-2 username">${data.username}</span>
                                <div class="d-flex justify-content-between">
                                    <div class="d-flex justify-content-betweens align-items-center">
                                        <div class="content">${data.content}</div>

                                    </div>
                                </div>
                            </div>
                            <p class="actions">
                                <span class="action-like">Thích</span>
                                .
                                <span class="action-comment" onclick="showReplyBox(this)">Trả lời</span>
                                .
                                <span class="date">${convert(data.updatedAt)}</span>
                            </p>
                        </div>


                    </div>
                    <div class="reply-container" style="display: none">
                        <div class="replyForm">
                            <input type="text" name="me_avatar" id="me_avatar" value=${data.avatar}
                                style="display: none">
                            <span class="round"><img src=${data.avatar} class="align-self-start mr-3"
                                    style="border-radius: 50%; height: 36px"></span>
                            <div class="reply-input">
                                <input type="text" name="me" id="me" value=${data.username} style="display: none">
                                <input type="text" name="reply" id="reply">
                                <input name="commentId" id="commentId" value="${data._id}" style="display: none">

                            </div>
                        </div>
                        <div class="reply-btn">
                            <button class="no-replySendBtn" onclick="hideReplyBox(this)">
                                Hủy
                            </button>
                            <button type="button" class="replySendBtn" onClick="sendReply(this)">Trả lời</button>
                        </div>
                    </div>

                     <div class="replyList">
                       
                        

                    <div class="replyList-body">

                    </div>

                    </div>
                    
                </div>`

                var commentBox = $("#commentBox-content")

                commentBox.html(html + commentBox.html())

            })

            socket.on("server_send_reply_comment", function (data) {
                console.log("here" + data)
                var html = `<div class="media d-flex align-items-start">
                      <input type="text" name="me_avatar" id="me_avatar" value="${data.avatar}" style="display: none">
                                <span class="round"><img src="${data.avatar}" class="align-self-start mr-3"
                                        style="border-radius: 50%; height: 36px"></span>
                                <div class="container">
                                    <div class="d-flex flex-column align-items-stretch justify-content-evenly comment-container"
                                        style="flex: 1">
                                        <span class="user pt-2 username"> ${data.username}</span>
                                        <div class="d-flex justify-content-between">
                                            <div class="d-flex justify-content-betweens align-items-center">
                                                <div class="content">${data.content}</div>

                                            </div>
                                        </div>
                                    </div>
                                    <p class="actions">
                                        <span class="action-like">Thích</span>
                                        .
                                        <span class="action-comment">Trả lời</span>
                                        .
                                        <span class="date">${convert(data.updatedAt)}</span>
                                    </p>
                                </div>
                            </div>`
                console.log(data.parentCommentId)
                var replyList = $(`#${data.parentCommentId} .replyList-body`)
                console.log(replyList)
                replyList.html(html + replyList.html())


            })




        })


    </script>


</body>