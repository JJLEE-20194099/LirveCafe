<link rel="stylesheet" href="/css/nam_book_detail.css">
<link rel="stylesheet" href="/css/jjlee_book_detail.css">
<link rel="stylesheet" href="/css/khang_book_detail_base.css">
<link rel="stylesheet" href="/css/khang_book_detail_main.css">
<link rel="stylesheet" href="/css/comment.css">

<body>

    <div id="product-detail-page">
        <div id="detail-and-buy" class="d-flex justify-content-center">

            <img class="product-img col col-6 d-flex justify-content-center" src="{{coffee.image}}">

            <input type="text" value="{{coffee.slug}}" id="slug" style="display: none">
            <input type="text" id="avg_rating" value="{{avg_rating}}" style="display: none">
            <div id="product-buy-detail" class="col col-6">

                <div class="detail-header">
                    <h2 class="detail-title" id="item_name" style="color: black; font-weight: 600">{{coffee.name}}</h2>

                    <div class="detail-rating" id="detail-rating">



                    </div>
                    {{#if commentList.length}}
                    <a href="#">(<span>{{commentList.length}}</span> đánh giá)</a>
                    {{/if}}

                    {{#if coffee.no_sold}}
                    <div class="detail-sold">Đã bán <span>{{coffee.no_sold}}</span></div>
                    {{/if}}

                </div>

                {{#if coffee.saleoff_status}}
                <div style="display: flex; align-items: center">
                    <div class="detail-cost">
                        {{coffee.saleoff_price}} VNĐ
                    </div>
                    <div class="discount-value">-<span
                            style="font-size: 18px; font-weight: bold">{{coffee.discountPercentage}}</span>%</div>
                </div>
                <div style="padding-left: 16px; color: #bb8817; font-size: 16; font-weight: bold">Có
                    {{coffee.no_sold_during_saleoff}}/{{sum coffee.sum_items_during_saleoff
                    coffee.no_sold_during_saleoff}} sản phẩm giảm giá đã bán</div>
                {{else}}
                <div class="detail-cost">
                    {{coffee.price}} VNĐ
                </div>
                {{/if}}

                <div class="detail-coupon">
                    <div class="coupon-text">Mã giảm giá</div>
                    <ul class="coupon-tags">
                        <li class="coupon-tag">Giảm 30k</li>
                        <li class="coupon-tag">Giảm 25k</li>
                        <li class="coupon-tag">Giảm 15k</li>
                        <a href="#"><i class="coupon-detail-icon ti-angle-right"></i></a>
                    </ul>

                </div>

                <div class="detail-buy">
                    {{!-- <p class="label">Số lượng</p> --}}

                    <div class="group-input">
                        {{!-- <button class="change-btn buy-btn" id="decre-btn"><i class="ti-minus"></i></button>
                        <input type="text" value="1" class="input">
                        <button class="change-btn buy-btn" id="incre-btn"><i class="ti-plus"></i></button> --}}

                        <div>
                            <button class="submit-btn buy-btn" id="buyItem">Chọn mua</button>
                            <button id="addItemToCart" class="submit-btn buy-btn">Add to cart</button>
                        </div>
                    </div>

                </div>

            </div>

        </div>


        <div class="">
            <div class="">
                <div class="detail__description">
                    <div class="detail__description-heading">
                        Mô Tả Sản Phẩm
                    </div>
                    <div class="detail__description-content">
                        {{coffee.description}}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        {{!-- home books --}}
        <div class="home-product" style="margin-left: 18px; margin-right: 18px; border-bottom: 0px, solid, #fff"
            id="home-books">

            <div class="product-header" id="books-header">
                <span>Có thể bạn thích</span>
                <i class="product-icon ti-book"></i>
            </div>

            <div class="carousel slide" style="height: 400px" data-ride="carousel" data-interval="5000">

                <div class="carousel-inner row w-100 mx-auto" style="height: 100%; box-shadow: none" role="listbox">

                    {{#each coffees}}

                    <a href="/coffee/{{this.slug}}" class="carousel-item col-md-3">

                        <div class="panel panel-default">
                            <div class="panel-thumbnail">
                                <div title="image 1" class="thumb">
                                    <img class="img-fluid mx-auto d-block" src="{{this.image}}" alt="slide 1">
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">{{this.name}}</h5>

                                <p class="card-text">{{this.description}}</p>

                                <div class="item-price flex">
                                    {{#if this.saleoff_status}}
                                    <div class="price-value"><span>{{this.saleoff_price}}</span> VNĐ</div>

                                    <div class="discount-value">-<span>{{this.discountPercentage}}</span>%</div>
                                    {{else}}

                                    <div class="price-value"><span>{{this.price}}</span> VNĐ</div>

                                    {{/if}}

                                </div>
                            </div>
                        </div>

                    </a>
                    {{/each}}

                </div>
                {{!-- book prev icon --}}
                <a class="carousel-control-prev" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                </a>
                {{!-- book next icon --}}
                <a class="carousel-control-next text-faded" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                </a>
            </div>

        </div>
        <h2 class="feedback-title" style="margin-left: 16px; font-weight: 600px; font-size: 32px">Feedback</h2>
        <div class="feedback-container">

            <div>
                <div id="commentForm">

                    {{#if user}}

                    <div class="reply-container">
                        <div class="replyForm">
                            <input type="text" name="username" class="user pt-2" id="username" value={{user.username}}
                                readonly style="display: none">
                            <input type="text" name="me_avatar" id="me_avatar" value={{user.avatar}}
                                style="display: none">
                            <input type="text" name="me_avatar" id="user_avatar" value={{user.avatar}}
                                style="display: none">
                            <span class="round"><img src="{{user.avatar}}" class="align-self-start mr-3"
                                    style="border-radius: 50%; height: 36px; width: 36px"></span>
                            <div class="reply-input">
                                <input type="text" name="content" placeholder="Bạn đánh giá gì về sản phẩm này?"
                                    style="font-size: 14px" onkeyup="showSendBox(this)" id="content">
                                <input name="itemId" id="itemId" value="{{coffee._id}}" style="display:none">

                            </div>
                        </div>
                        <div id="send-box" class="reply-btn" style="display: none">
                            <button class="no-replySendBtn" onclick="hideCommentBox(this)">
                                Hủy
                            </button>
                            <button type="button" class="replySendBtn" id="commentSendBtn" onClick="sendReply(this)"
                                disabled="disabled">Đánh giá</button>
                        </div>
                    </div>

                    {{/if}}
                </div>
            </div>
            <div id="commentBox">
                {{#if commentList.length}}
                <h3 style="height: 70px; margin-top: 12; margin-bottom: 12; display: flex; align-items: center">Comment
                    (<span id="no_comment">{{commentList.length}}</span>)</h3>
                <div id="commentBox-content">
                    {{#each commentList}}
                    <div id="{{this._id}}" class="each_comment_box">
                        <div class="media d-flex align-items-start">
                            <span class="round"><img src="{{this.avatar}}" class="align-self-start mr-3"
                                    style="border-radius: 50%; height: 36px; width: 36px"></span>
                            <div class="container">
                                <div class="d-flex flex-column align-items-stretch justify-content-evenly comment-container"
                                    style="flex: 1">
                                    <span class="user pt-2 username">{{this.username}}</span>
                                    {{#if this.rating}}
                                    <span style="font-weight: bold; color: black;">đã đánh giá <span
                                            style="font-weight: bold; color: #f5ba3f">{{this.rating}} sao</span></span>
                                    {{/if}}
                                    <div class="d-flex justify-content-between">
                                        <div class="d-flex justify-content-betweens align-items-center">
                                            <div class="content">{{this.content}}</div>
                                        </div>
                                    </div>
                                </div>
                                <p class="actions">
                                    <span class="action-like">Thích</span>
                                    .
                                    <span class="action-comment" onclick="showReplyBox(this)">Trả lời</span>
                                    .
                                    <span class="date">{{this.updatedAt}}</span>
                                </p>
                            </div>
                        </div>

                        <div class="reply-container" style="display: none">
                            <div class="replyForm">
                                <input type="text" name="me_avatar" id="me_avatar" value={{../user.avatar}}
                                    style="display: none">
                                <span class="round"><img src="{{../user.avatar}}" class="align-self-start mr-3"
                                        style="border-radius: 50%; height: 36px; width: 36px"></span>
                                <div class="reply-input">
                                    <input type="text" name="me" id="me" value={{../user.username}}
                                        style="display: none">
                                    <input type="text" name="reply" id="reply" onkeyup="changeBtnStatus(this)">
                                    <input name="commentId" id="commentId" value="{{this._id}}" style="display: none">

                                </div>
                            </div>
                            <div class="reply-btn">
                                <button class="no-replySendBtn" onclick="hideReplyBox(this)">
                                    Hủy
                                </button>
                                <button type="button" class="replySendBtn" onClick="sendReply(this)">Trả lời</button>
                            </div>
                        </div>

                        <div class="replyList">
                            {{#if this.replyList.length}}
                            <h3 class="replyList-title"
                                style="margin-left: 31px; margin-right: 12px; height: 60px; cursor: pointer"
                                onClick="toggleReplyList(this)">Xem {{this.replyList.length}} phản hồi
                            </h3>

                            <div class="replyList-body" style="display: none">
                                {{#each this.replyList}}
                                <div class="media d-flex align-items-start">
                                    <span class="round"><img src="{{this.avatar}}" class="align-self-start mr-3"
                                            style="border-radius: 50%; height: 36px; width: 36px"></span>
                                    <div class="container">
                                        <div class="d-flex flex-column align-items-stretch justify-content-evenly comment-container"
                                            style="flex: 1">
                                            <span class="user pt-2 username-reply">{{this.username}}</span>
                                            <div class="d-flex justify-content-between">
                                                <div class="d-flex justify-content-betweens align-items-center">
                                                    <div class="content">{{this.content}}</div>

                                                </div>
                                            </div>
                                        </div>
                                        <p class="actions">
                                            <span class="action-like">Thích</span>
                                            .
                                            <span class="action-comment">Trả lời</span>
                                            .
                                            <span class="date">{{this.updatedAt}}</span>
                                        </p>
                                    </div>
                                </div>
                                {{/each}}


                            </div>

                            {{else}}
                            <div class="replyList-body" style="display: none">


                            </div>
                            {{/if}}

                        </div>
                    </div>
                    {{/each}}
                </div>
                {{else}}
                <h3 id="zero_comment_title_format"
                    style="height: 70px; margin-top: 12; margin-bottom: 12; display: none; align-items: center">Comment
                    (<span id="no_comment">0</span>)</h3>
                <input type="text" id="no-comment" value="0" hidden>
                <h3 id="zero_comment_title"
                    style="height: 70px; margin-top: 12; margin-bottom: 12; display: flex; align-items: center">Chưa có
                    đánh giá cho sản phẩm này</h3>
                <div id="commentBox-content">

                </div>
                {{/if}}
            </div>
        </div>


    </div>

    <div id="notice">

    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="../socket.io/socket.io.js"></script>
    <script src="/js/datetime_handling.js"></script>

    <script src="/js/book_detail.js"></script>
    <script>
        var socket = io("http://localhost:3000")

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showSendBox(input) {

            if (input.value == '') {
                document.getElementById("commentSendBtn").style.backgroundColor = "#ccc"
                document.getElementById("commentSendBtn").disabled = true
            } else {
                document.getElementById("commentSendBtn").style.backgroundColor = "#c39e51"
                document.getElementById("commentSendBtn").disabled = false
            }

        }

        function showReplyBox(btn) {
            const commentId = btn.parentElement.parentElement.parentElement.parentElement.id
            $(`#${commentId} .reply-container`).css('display', 'block')
            var check = $(`#${commentId} .reply-container #reply`).val()
            if (check == '') {
                $(`#${commentId} .replySendBtn`).css('background-color', "#ccc")
                $(`#${commentId} .replySendBtn`).prop('disabled', true)
            } else {
                $(`#${commentId} .replySendBtn`).css('background-color', "#c39e51")
                $(`#${commentId} .replySendBtn`).prop('disabled', false)
            }
        }

        var save_text = ''
        function toggleReplyList(tag) {
            const commentId = tag.parentElement.parentElement.id
            if ($(`#${commentId} .replyList-body`).css('display') == 'none') {
                $(`#${commentId} .replyList-body`).css('display', 'block')
                save_text = tag.innerHTML
                tag.innerHTML = "Ẩn"
            } else {
                $(`#${commentId} .replyList-body`).css('display', 'none')
                tag.innerHTML = save_text
            }

        }

        function changeBtnStatus(input) {

            const commentId = input.parentElement.parentElement.parentElement.parentElement.id
            if (input.value == '') {
                $(`#${commentId} .replySendBtn`).css('background-color', "#ccc")
                $(`#${commentId} .replySendBtn`).prop('disabled', true)
            } else {
                $(`#${commentId} .replySendBtn`).css('background-color', "#c39e51")
                $(`#${commentId} .replySendBtn`).prop('disabled', false)
            }
        }

        function hideCommentBox(btn) {
            $(`#commentBox #content`).val('')
            $(`#send-box`).css('display', "none")
        }

        function hideReplyBox(btn) {
            const commentId = btn.parentElement.parentElement.parentElement.id
            $(`#${commentId} .reply-container`).css('display', "none")
            $(`#${commentId} #reply`).val('')
        }

        function sendReply(replyButton) {
            const commentId = replyButton.parentElement.parentElement.parentElement.id
            $(`#${commentId} .reply-container`).css('display', 'none')
            const data = {
                username: $(`#${commentId} .replyForm #me`).val(),
                content: $(`#${commentId} .replyForm #reply`).val(),
                avatar: $(`#${commentId} .replyForm #me_avatar`).val(),
                parentCommentId: commentId,
                itemId: $("#itemId").val(),
                receiver: $(`#${commentId} .username`).text(),
                slug: $(`#slug`).val()
            }



            $.ajax({
                url: '/coffee/reply-comment',
                method: 'POST',
                data: data,
                success: function (res) {

                    socket.emit("client_send_reply_comment", data)
                }
            });
            return false;
        }

        function read_info(tag) {
            id = tag.id
            $.ajax({
                url: `/notis/index/:${id}`,
                method: 'POST',
                data: { id: id },
                success: function (res) {
                    where_url = res.where_url
                    window.location.href = where_url
                }
            });
        }




        $(document).ready(function () {

            const avg_rating = $('#avg_rating').val()
            const light_star = parseInt(avg_rating)
            const dark_star = 5 - light_star
            var star_html = '';
            for (var i = 0; i < light_star; i++) {
                star_html += ` <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" size="16"
                            color="#fdd836" height="16" width="16" xmlns="http://www.w3.org/2000/svg"
                            style="color: rgb(253, 216, 54);">
                            <path
                                d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z">
                            </path>
                        </svg>`
            }

            for (var j = 0; j < dark_star; j++) {
                star_html += `<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" size="16"
                            color="#c7c7c7" style="color:#c7c7c7" height="16" width="16"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z">
                            </path>
                        </svg>`
            }

            console.log("avg rating: ", avg_rating)

            $('#detail-rating').html(star_html)

            $("#content").focus(function () {
                $("#send-box").css("display", "flex")
            })

            if ($("#content").val() == '') {
                $("#commentSendBtn").css("background-color", "#ccc");
            }




            $("#commentSendBtn").click(function () {

                var data = {
                    username: $("#username").val(),
                    content: $("#content").val(),
                    itemId: $("#itemId").val(),
                    avatar: $("#user_avatar").val()
                }



                $.ajax({
                    url: "/coffee/do-comment",
                    method: "POST",
                    data: data,
                    success: function (res) {
                        socket.emit("client_send_comment_to_book_item", res)
                    }
                });

                quantity = parseInt($('#no_comment').text()) + 1
                $('#no_comment').text(quantity)
                return false;
            });

            const data = {
                username: $("#username").val(),
                itemId: $("#itemId").val(),
            }



            $("#addItemToCart").click(function () {


                $.ajax({
                    url: '/carts/add-coffee-to-cart',
                    method: "POST",
                    data: data,
                    success: function (res) {

                        $("#cart-number").text(res.itemList.length);
                    }
                })

            })

            $("#buyItem").click(function () {


                $.ajax({
                    url: '/carts/add-coffee-to-cart',
                    method: "POST",
                    data: data,
                    success: function (res) {

                        location.href = `/carts/show/${res.username}?level=${res.level}&activating=${res.activating}`
                    }
                })


            })


            socket.on("server_send_comment_to_book_item", function (data) {
                $("#send-box").css("display", "none")
                $("#content").val('')
                $("#commentSendBtn").css("background-color", "#ccc");


                var html = `
                <div id="${data._id}" class="each_comment_box">
                    
                    <div class="media d-flex align-items-start">
                        <span class="round"><img src="${data.avatar}" class="align-self-start mr-3"
                                style="border-radius: 50%; height: 36px;  width: 36px"></span>
                        <div class="container">
                            <div class="d-flex flex-column align-items-stretch justify-content-evenly comment-container"
                                style="flex: 1">
                                <span class="user pt-2 username">${data.username}</span>
                                <div class="d-flex justify-content-between">
                                    <div class="d-flex justify-content-betweens align-items-center">
                                        <div class="content">${data.content}</div>

                                    </div>
                                </div>
                            </div>
                            <p class="actions">
                                <span class="action-like">Thích</span>
                                .
                                <span class="action-comment" onclick="showReplyBox(this)">Trả lời</span>
                                .
                                <span class="date">${convert(data.updatedAt)}</span>
                            </p>
                        </div>


                    </div>
                    <div class="reply-container" style="display: none">
                        <div class="replyForm">
                            <input type="text" name="me_avatar" id="me_avatar" value=${data.avatar}
                                style="display: none">
                            <span class="round"><img src=${data.avatar} class="align-self-start mr-3"
                                    style="border-radius: 50%; height: 36px; width: 36px"></span>
                            <div class="reply-input">
                                <input type="text" name="me" id="me" value=${data.username} style="display: none">
                                <input type="text" name="reply" id="reply" onkeyup="changeBtnStatus(this)">
                                <input name="commentId" id="commentId" value="${data._id}" style="display: none">

                            </div>
                        </div>
                        <div class="reply-btn">
                            <button class="no-replySendBtn" onclick="hideReplyBox(this)">
                                Hủy
                            </button>
                            <button type="button" class="replySendBtn" onClick="sendReply(this)">Trả lời</button>
                        </div>
                    </div>

                    <div class="replyList">
                       
                        <div class="replyList-body">

                        </div>

                    </div>
                    
                </div>`

                var quantity = parseInt($('#no_comment').html())
                if (quantity == 1) {

                    $('#no_comment').html(1)
                    $('#zero_comment_title_format').css('display', 'flex')
                    $('#zero_comment_title').css('display', 'none')
                }


                var commentBox = $("#commentBox-content")

                commentBox.html(html + commentBox.html())

            })

            socket.on("server_send_reply_comment", function (data) {

                var html = `<div class="media d-flex align-items-start">
                      <input type="text" name="me_avatar" id="me_avatar" value="${data.avatar}" style="display: none">
                                <span class="round"><img src="${data.avatar}" class="align-self-start mr-3"
                                        style="border-radius: 50%; height: 36px; width: 36px"></span>
                                <div class="container">
                                    <div class="d-flex flex-column align-items-stretch justify-content-evenly comment-container"
                                        style="flex: 1">
                                        <span class="user pt-2 username-reply"> ${data.username}</span>
                                        <div class="d-flex justify-content-between">
                                            <div class="d-flex justify-content-betweens align-items-center">
                                                <div class="content">${data.content}</div>

                                            </div>
                                        </div>
                                    </div>
                                    <p class="actions">
                                        <span class="action-like">Thích</span>
                                        .
                                        <span class="action-comment">Trả lời</span>
                                        .
                                        <span class="date">${convert(data.updatedAt)}</span>
                                    </p>
                                </div>
                            </div>`




                $(`#${data.parentCommentId} .replyList-title`).css('display', 'none')
                $(`#${data.parentCommentId} #reply`).val('')
                var replyList = $(`#${data.parentCommentId} .replyList-body`)
                replyList.html(html + replyList.html())
                replyList.css("display", "block")
                $("#no-noti-title").css('display', 'none')


            })

            socket.on("server_send_notice", function (data) {

                notice_data = {
                    sender: data.username,
                    receiver: data.receiver,
                    where_url: `http://localhost:3000/coffee/${data.slug}`,
                    itemId: data.itemId,
                    avatar: data.avatar
                }


                if (notice_data.sender != notice_data.receiver) {
                    $.ajax({
                        url: '/coffee/post-notice',
                        method: "POST",
                        data: notice_data,
                        success: function (res) {
                            notice_data._id = res._id
                            noti_box = $("#noti-box")
                            new_noti = `<div class="noti-each" onClick="read_info(this)" id="${notice_data._id}" style="background-color: #d5c6a6">
                        <div>
                           
                            <img src="${notice_data.avatar}" class="noti-img"alt="logo-brand">
                        </div>
                        
                        <div class="noti-main">
                            <div class="noti-content" >
                                <div>
                                    <span class="noti-username" style="font-weight: bold!important;">${notice_data.sender}</span> <span class="noti-type" style="font-weight: bold!important;">đã nhắc đến bạn </span> <span style="font-weight: bold!important;">trong</span> <span class="noti-where" style="font-weight: bold!important;">${$('#item_name').text()}</span>
                                </div>
                            </div>
                            <div class="noti-time date">
                                ${convert(notice_data.createdAt)}
                            </div>
                        </div>
                    </div>`


                            html = new_noti + noti_box.html()
                            noti_box.html(html)

                            if ($('#noti-number').text() == '') {
                                $('#noti-number').addClass("header-number")
                                $('#noti-number').html(1)
                            } else {

                                $('#noti-number').html(parseInt($('#noti-number').text()) + 1)
                            }

                            $("#notice").html(`
                                        
                                            
                                                <div class="noti-each" id="${notice_data._id}"  onClick="read_info(this)" style="background-color: #d5c6a6; width: 374px; height: 110px; position: fixed; right: -374px; bottom: 0; box-shadow: 0 4px 8px 0 black, 0 6px 20px 0 #220202; cursor: pointer">
                                                    <div href="${notice_data.where_url}">
                                                        <img src="${notice_data.avatar}" class="noti-img"alt="logo-brand">
                                                    </div>
                                                    
                                                    <div class="noti-main">
                                                        <div class="noti-content" >
                                                            <div href="${notice_data.where_url}" style="color: black">
                                                                <span class="noti-username" style="color: black">${notice_data.sender}</span> <span class="noti-type" style="color: black">đã nhắc đến bạn </span> trong <span href="${notice_data.where_url}" class="noti-where" style="color: black">${$('#item_name').text()}</span>
                                                            </div>
                                                        </div>
                                                        <div class="noti-time date">
                                                            ${convert(notice_data.createdAt)}
                                                        </div>
                                                    </div>
                                                </div>
                                           
                                        `)

                            $("#notice .noti-each").animate({ "right": "+=374px" }, 3000);
                            setTimeout(function () {
                                $("#notice .noti-each").animate({ "right": "-=374px" }, 3000);

                            }, 10000)
                        }
                    })





                }
            })
        })
    </script>
</body>